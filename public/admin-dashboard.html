<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tindo Admin Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  
  <style>
    /* üî• Universal button animation (CTC style) */
    button {
      transition: all 0.15s ease;
      position: relative;
      overflow: hidden;
    }
    button:active {
      transform: scale(0.95);
    }
    button::after {
      content: "";
      position: absolute;
      left: 50%;
      top: 50%;
      width: 0;
      height: 0;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: width 0.4s ease, height 0.4s ease;
    }
    button:active::after {
      width: 150%;
      height: 150%;
    }
    
    /* üîî Toast notifications */
    #toast {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background: #22c55e;
      color: white;
      padding: 12px 20px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.3s, transform 0.3s;
      z-index: 9999;
    }
    #toast.show {
      opacity: 1;
      transform: translateY(0);
    }
  </style>
</head>
<body class="bg-green-50 text-gray-900">

<!-- Navbar -->
<header class="bg-white shadow sticky top-0 z-50">
  <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
    <h1 class="text-2xl font-bold text-green-600">üõ†Ô∏è Tindo Admin</h1>
    <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-medium transition-all duration-200 shadow-md hover:shadow-lg">Logout</button>
  </div>
</header>

<!-- Dashboard -->
<section class="max-w-7xl mx-auto p-6">
  <h2 class="text-3xl font-bold text-green-600 mb-6">üìä Admin Dashboard</h2>

  <!-- Stats -->
  <div class="grid md:grid-cols-3 gap-6 mb-6">
    <div class="bg-white p-4 rounded-xl shadow text-center">
      <h3 class="font-bold">Total Users</h3>
      <p id="totalUsers" class="text-2xl text-green-600">0</p>
    </div>
    <div class="bg-white p-4 rounded-xl shadow text-center">
      <h3 class="font-bold">Total Restaurants</h3>
      <p id="totalRestaurants" class="text-2xl text-green-600">0</p>
    </div>
    <div class="bg-white p-4 rounded-xl shadow text-center">
      <h3 class="font-bold">Total Orders</h3>
      <p id="totalOrders" class="text-2xl text-green-600">0</p>
    </div>
  </div>

  <!-- üìä Analytics -->
  <div class="bg-white p-6 rounded-xl shadow mb-6">
    <h3 class="text-xl font-bold mb-4">üìà Platform Analytics</h3>
    <div class="grid md:grid-cols-2 gap-6">
      <div class="card bg-green-50 p-4 rounded shadow">
        <h4 class="font-bold mb-2">Orders Growth</h4>
        <canvas id="ordersChart"></canvas>
      </div>
      <div class="card bg-green-50 p-4 rounded shadow">
        <h4 class="font-bold mb-2">Revenue Growth</h4>
        <canvas id="revenueChart"></canvas>
      </div>
    </div>
  </div>

  <!-- üè™ Restaurant Approvals -->
  <div class="bg-white p-6 rounded-xl shadow mb-6">
    <h3 class="text-xl font-bold mb-4">üè™ Pending Restaurants</h3>
    <div id="pendingRestaurants" class="space-y-3"></div>
  </div>

  <!-- üçΩÔ∏è All Menu Items -->
  <div class="bg-white p-6 rounded-xl shadow mb-6">
    <h3 class="text-xl font-bold mb-4">üçΩÔ∏è All Menu Items</h3>
    <div id="adminMenuList" class="grid md:grid-cols-3 gap-6"></div>
  </div>

  <!-- üö¥ Delivery Boys List -->
  <div class="bg-white p-6 rounded-xl shadow mb-6">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-xl font-bold">üö¥ Delivery Boys</h3>
      <label class="text-sm text-gray-600 flex items-center gap-2">
        View:
        <select id="agentFilter" class="border rounded px-2 py-1 text-sm">
          <option value="active" selected>Active only</option>
          <option value="all">All</option>
        </select>
      </label>
    </div>
    <div id="deliveryList" class="space-y-3"></div>
  </div>

  <!-- üìç Delivery Boys Location Map -->
  <div class="bg-white p-6 rounded-xl shadow mb-6">
    <h3 class="text-xl font-bold mb-4">üìç Delivery Boys Location</h3>
    <div id="map" style="height:400px;" class="rounded"></div>
  </div>

  <!-- üì¶ Active Orders -->
  <div class="bg-white p-6 rounded-xl shadow mb-6">
    <h3 class="text-xl font-bold mb-4">üì¶ Active Orders</h3>
    <div id="activeOrders" class="space-y-3"></div>
  </div>

    <!-- ‚≠ê Top Restaurants Management -->
    <div class="bg-white p-6 rounded-xl shadow mb-6">
      <h3 class="text-xl font-bold mb-4">‚≠ê Top Restaurants (Homepage Section)</h3>
      <!-- Add Top Restaurant -->
      <div class="mb-6 p-4 bg-green-50 rounded-xl">
        <h4 class="font-semibold text-green-800 mb-3">Add Restaurant to Top List</h4>
        <div class="flex gap-4 items-end">
          <div class="flex-1">
            <label class="block text-sm font-medium text-gray-700 mb-2">Restaurant ID</label>
            <input type="number" id="topRestaurantId" placeholder="Enter Restaurant ID" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          </div>
          <div class="w-24">
            <label class="block text-sm font-medium text-gray-700 mb-2">Position</label>
            <input type="number" id="topPosition" placeholder="1" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          </div>
          <button onclick="addTopRestaurant()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-all duration-200 shadow-md hover:shadow-lg">Add Top</button>
        </div>
        <h4 class="font-semibold text-green-800 mb-3 mt-6">Control Top Restaurants</h4>
        <div id="topRestaurantsList" class="space-y-3">
          <!-- Dynamic content will be loaded here -->
        </div>
      </div>
    </div>
  
  <!-- üåü Featured Restaurants Management -->
  <div class="bg-white p-6 rounded-xl shadow mb-6">
    <h3 class="text-xl font-bold mb-4">üåü Featured Restaurants (Homepage Banner)</h3>
    
    <!-- Add Featured Restaurant -->
    <div class="mb-6 p-4 bg-green-50 rounded-xl">
      <h4 class="font-semibold text-green-800 mb-3">Add Restaurant to Featured List</h4>
      <div class="flex gap-4 items-end">
        <div class="flex-1">
          <label class="block text-sm font-medium text-gray-700 mb-2">Restaurant ID</label>
          <input type="number" id="featuredRestaurantId" placeholder="Enter Restaurant ID" 
                 class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
        </div>
        <div class="w-24">
          <label class="block text-sm font-medium text-gray-700 mb-2">Position</label>
          <input type="number" id="featuredPosition" placeholder="1" min="1" 
                 class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
        </div>
        <button onclick="addFeaturedRestaurant()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition-all duration-200 shadow-md hover:shadow-lg">
          Add Featured
        </button>
      </div>
    </div>

    <!-- Current Featured Restaurants -->
    <div>
      <h4 class="font-semibold text-gray-800 mb-3">Current Featured Restaurants</h4>
      <div id="featuredRestaurantsList" class="space-y-3">
        <!-- Dynamic content will be loaded here -->
      </div>
    </div>
  </div>

  <!-- üì¢ Notifications -->
  <div class="bg-white p-6 rounded-xl shadow">
    <h3 class="text-xl font-bold mb-4">üîî Notifications</h3>
    <ul id="notifications" class="space-y-2"></ul>
  </div>
</section>

<!-- Toast notification -->
<div id="toast"></div>

<script>
const BASE = "http://localhost:5000";
const socket = io(BASE);

// ‚úÖ Auth check
const user = JSON.parse(localStorage.getItem("user"));
const token = localStorage.getItem("token");
if (!user || user.role !== "admin" || !token) {
  alert("Unauthorized! Please login again.");
  window.location.href = "login.html";
}

// ‚úÖ Toast function
function showToast(message, success = true) {
  let toast = document.getElementById("toast");
  toast.style.background = success ? "#22c55e" : "#ef4444";
  toast.textContent = message;
  toast.classList.add("show");
  setTimeout(() => toast.classList.remove("show"), 3000);
}

// ===== Stats =====
async function loadStats() {
  let resUsers = await fetch(`${BASE}/api/admin/users`);
  let users = await resUsers.json();
  document.getElementById("totalUsers").textContent = users.length;

  let resRest = await fetch(`${BASE}/api/admin/restaurants`); // ‚úÖ changed
  let restaurants = await resRest.json();
  document.getElementById("totalRestaurants").textContent = restaurants.length;

  let resOrders = await fetch(`${BASE}/api/orders/all`);
  let orders = await resOrders.json();
  document.getElementById("totalOrders").textContent = orders.length;
}

// ===== Pending Restaurants =====
async function loadPendingRestaurants() {
  let res = await fetch(`${BASE}/api/admin/restaurants`);
  let data = await res.json();
  console.log("Admin restaurants API data:", data); // üëà debug log

  const list = document.getElementById("pendingRestaurants");
  const pending = data.filter(r => (r.status || "").toLowerCase() === "pending");

  if (!pending.length) {
    list.innerHTML = `<p class="text-gray-500">No pending approvals</p>`;
    return;
  }

  list.innerHTML = pending.map(r => `
    <div class="card bg-green-50 p-4 rounded-xl shadow flex justify-between items-center">
      <div>
        <h3 class="font-bold">${r.name}</h3>
        <p class="text-sm text-gray-500">${r.email}</p>
      </div>
      <div class="flex gap-2">
        <button onclick="approveRestaurant(${r.id})" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition-all duration-200 shadow-md hover:shadow-lg">‚úÖ Approve</button>
        <button onclick="rejectRestaurant(${r.id})" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium transition-all duration-200 shadow-md hover:shadow-lg">‚ùå Reject</button>
      </div>
    </div>
  `).join("");
}

async function approveRestaurant(id){
  try {
    const res = await fetch(`${BASE}/api/admin/restaurants/approve/${id}`, { method:"PUT" });
    const result = await res.json();
    if (res.ok) {
      showToast("‚úÖ Restaurant approved successfully!");
      loadPendingRestaurants();
      loadStats(); // Refresh stats
    } else {
      showToast("‚ùå " + (result.error || "Failed to approve restaurant"), false);
    }
  } catch (err) {
    showToast("‚ùå Network error", false);
    console.error("Approve error:", err);
  }
}

async function rejectRestaurant(id){
  try {
    const res = await fetch(`${BASE}/api/admin/restaurants/reject/${id}`, { method:"PUT" });
    const result = await res.json();
    if (res.ok) {
      showToast("‚ùå Restaurant rejected");
      loadPendingRestaurants();
      loadStats(); // Refresh stats
    } else {
      showToast("‚ùå " + (result.error || "Failed to reject restaurant"), false);
    }
  } catch (err) {
    showToast("‚ùå Network error", false);
    console.error("Reject error:", err);
  }
}

// ===== All Menu Items =====
async function loadAllMenu(){
  let res = await fetch(`${BASE}/api/admin/menu`);
  let data = await res.json();
  const list = document.getElementById("adminMenuList");
  if (!data.length) {
    list.innerHTML = `<p class="text-gray-500">No menu items found</p>`;
    return;
  }
  list.innerHTML = data.map(m => `
    <div class="card bg-green-50 p-4 rounded-xl shadow">
      ${m.image_url ? `<img src="${BASE}/uploads/${m.image_url}" class="h-32 w-full object-cover rounded mb-3">` : ""}
      <h3 class="font-bold text-lg">${m.item_name}</h3>
      <p class="text-sm text-gray-500">${m.description || ''}</p>
      <p class="text-green-600 font-semibold">‚Çπ${m.price}</p>
      <p class="text-xs text-gray-400">Restaurant: ${m.restaurant_name}</p>
    </div>
  `).join("");
}

// ===== Delivery Boys =====
async function loadDeliveryBoys() {
  const filterSel = document.getElementById('agentFilter');
  const view = (filterSel && filterSel.value === 'all') ? 'all=true' : '';
  const url = view ? `${BASE}/api/admin/delivery?${view}` : `${BASE}/api/admin/delivery`;
  let res = await fetch(url);
  let data = await res.json();
  const list = document.getElementById("deliveryList");
  if (!data.length) {
    list.innerHTML = `<p class="text-gray-500">No delivery boys active</p>`;
    return;
  }
  list.innerHTML = data.map(d => `
    <div class="card bg-green-50 p-4 rounded-xl shadow flex justify-between items-center">
      <div>
        <h3 class="font-bold">${d.name}</h3>
        <p class="text-sm text-gray-500">${d.email} | ${d.phone}</p>
      </div>
      <span class="${(d.status||'').toLowerCase()==='active' ? 'text-green-600' : 'text-gray-500'} font-bold">${d.status || 'Inactive'}</span>
    </div>
  `).join("");

  // Seed/refresh map markers with current active agents
  // Clear existing markers before re-seeding
  Object.values(deliveryMarkers).forEach(m => { try { map.removeLayer(m); } catch(_){} });
  deliveryMarkers = {};
  data.forEach(d => {
    const lat = Number(d.lat);
    const lng = Number(d.lng);
    if (Number.isFinite(lat) && Number.isFinite(lng)) {
      if (deliveryMarkers[d.id]) {
        deliveryMarkers[d.id].setLatLng([lat, lng]);
      } else {
        deliveryMarkers[d.id] = L.marker([lat, lng]).addTo(map).bindPopup(`${d.name} (#${d.id}) - ${d.status || 'Unknown'}`);
      }
    }
  });
}

// Hook filter change
document.addEventListener('change', (e) => {
  if (e.target && e.target.id === 'agentFilter') {
    loadDeliveryBoys();
  }
});

// ===== Delivery Boys Location Map =====
let map = L.map("map").setView([17.385, 78.486], 12); // default Hyderabad
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
let deliveryMarkers = {};

// Support both legacy 'agentLocation' and new 'locationUpdate' events
socket.on("agentLocation", (data) => {
  const { agent_id, lat, lng } = data || {};
  if (agent_id == null) return;
  if (deliveryMarkers[agent_id]) {
    deliveryMarkers[agent_id].setLatLng([lat, lng]);
  } else {
    deliveryMarkers[agent_id] = L.marker([lat, lng]).addTo(map).bindPopup("Delivery Agent #" + agent_id);
  }
});
socket.on("locationUpdate", (data) => {
  const { agentId, lat, lng } = data || {};
  if (agentId == null) return;
  if (deliveryMarkers[agentId]) {
    deliveryMarkers[agentId].setLatLng([lat, lng]);
  } else {
    deliveryMarkers[agentId] = L.marker([lat, lng]).addTo(map).bindPopup("Delivery Agent #" + agentId);
  }
});

// ===== Active Orders =====
async function loadActiveOrders() {
  let res = await fetch(`${BASE}/api/admin/orders`);
  let orders = await res.json();
  const list = document.getElementById("activeOrders");
  if (!orders.length) {
    list.innerHTML = `<p class="text-gray-500">No active orders</p>`;
    return;
  }
  list.innerHTML = orders.map(o => `
    <div class="card bg-green-50 p-3 rounded shadow">
      <p><strong>Order #${o.id} ${o.order_id ? '('+o.order_id+')' : ''}</strong> - ${o.items ? JSON.parse(o.items).map(i => i.name).join(", ") : ""}</p>
      <p class="text-sm text-gray-600">Status: ${o.status}</p>
      <div class="mt-2">
        <button onclick="assignAgent(${o.id})" class="bg-blue-600 text-white px-3 py-1 rounded text-sm">Auto-Assign Agent</button>
      </div>
    </div>
  `).join("");
}

async function assignAgent(orderId){
  try {
    const res = await fetch(`${BASE}/api/admin/orders/${orderId}/assign`, { method: 'POST' });
    const data = await res.json();
    if (res.ok) {
      showToast(`‚úÖ Assigned agent #${data.agent_id} to order #${orderId}`);
      loadActiveOrders();
    } else {
      showToast('‚ùå ' + (data.error || 'Failed to assign agent'), false);
    }
  } catch (e) {
    showToast('‚ùå Network error', false);
  }
}

// ===== Notifications =====
socket.on("newOrder", (order) => {
  const noti = document.createElement("li");
  noti.className = "bg-green-100 p-3 rounded shadow";
  noti.textContent = `üì¶ New Order #${order.id} placed by ${order.customer_name}`;
  document.getElementById("notifications").prepend(noti);
  loadActiveOrders();
});

// ===== Featured Restaurants Management =====
// ===== Top Restaurants Management =====
async function addTopRestaurant() {
  const restaurantId = document.getElementById("topRestaurantId").value;
  const position = document.getElementById("topPosition").value || 1;
  if (!restaurantId) {
    showToast("Please enter a restaurant ID", false);
    return;
  }
  try {
    const res = await fetch(`${BASE}/api/admin/top-restaurants`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ restaurant_id: parseInt(restaurantId), position: parseInt(position) })
    });
    const result = await res.json();
    if (res.ok) {
      showToast("‚úÖ Restaurant added to top list!");
      document.getElementById("topRestaurantId").value = "";
      document.getElementById("topPosition").value = "";
      loadTopRestaurants();
    } else {
      showToast("‚ùå " + (result.error || "Failed to add restaurant"), false);
    }
  } catch (err) {
    showToast("‚ùå Network error", false);
    console.error("Add top restaurant error:", err);
  }
}
async function loadTopRestaurants() {
  try {
    const res = await fetch(`${BASE}/api/admin/top-restaurants`);
    const data = await res.json();
    const list = document.getElementById("topRestaurantsList");
    if (!data.length) {
      list.innerHTML = `<p class="text-gray-500">No top restaurants found</p>`;
      return;
    }
    list.innerHTML = data.map(tr => `
      <div class="card bg-blue-50 p-4 rounded-xl shadow flex justify-between items-center">
        <div>
          <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center mb-2">
            <span class="text-blue-600 font-bold">#${tr.position}</span>
          </div>
          <h3 class="font-bold text-gray-800">${tr.name}</h3>
          <p class="text-sm text-gray-500">ID: ${tr.restaurant_id} | ${tr.cuisine || 'Multi Cuisine'}</p>
          <span class="inline-block px-2 py-1 text-xs rounded-full ${tr.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
            ${tr.is_active ? 'Active' : 'Inactive'}
          </span>
        </div>
        <div class="flex gap-2">
          <button onclick="toggleTopRestaurant(${tr.id}, ${tr.is_active})" class="px-3 py-1 rounded text-sm ${tr.is_active ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-blue-500 hover:bg-blue-600'} text-white transition-all duration-200">
            ${tr.is_active ? 'Deactivate' : 'Activate'}
          </button>
          <button onclick="removeTopRestaurant(${tr.id})" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm transition-all duration-200">Remove</button>
        </div>
      </div>
    `).join("");
  } catch (err) {
    console.error("Error loading top restaurants:", err);
    showToast("Failed to load top restaurants", false);
  }
}

async function toggleTopRestaurant(id, currentStatus) {
  try {
    const res = await fetch(`${BASE}/api/admin/top-restaurants/${id}/toggle`, {
      method: "PUT"
    });
    const result = await res.json();
    if (res.ok) {
      showToast(`‚úÖ Restaurant ${result.is_active ? 'activated' : 'deactivated'}`);
      loadTopRestaurants();
    } else {
      showToast("‚ùå " + (result.error || "Failed to toggle top restaurant"), false);
    }
  } catch (err) {
    showToast("‚ùå Network error", false);
    console.error("Toggle top restaurant error:", err);
  }
}
async function loadFeaturedRestaurants() {
  try {
    const res = await fetch(`${BASE}/api/admin/featured-restaurants`);
    const data = await res.json();
    
    const list = document.getElementById("featuredRestaurantsList");
    if (!data.length) {
      list.innerHTML = `<p class="text-gray-500">No featured restaurants yet</p>`;
      return;
    }
    
    list.innerHTML = data.map(fr => `
      <div class="card bg-green-50 p-4 rounded-xl shadow flex justify-between items-center">
        <div class="flex items-center gap-4">
          <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
            <span class="text-green-600 font-bold">#${fr.position}</span>
          </div>
          <div>
            <h3 class="font-bold text-gray-800">${fr.name}</h3>
            <p class="text-sm text-gray-500">ID: ${fr.restaurant_id} | ${fr.cuisine || 'Multi Cuisine'}</p>
            <span class="inline-block px-2 py-1 text-xs rounded-full ${fr.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
              ${fr.is_active ? 'Active' : 'Inactive'}
            </span>
          </div>
        </div>
        <div class="flex gap-2">
          <button onclick="toggleFeaturedRestaurant(${fr.id}, ${fr.is_active})" 
                  class="px-3 py-1 rounded text-sm ${fr.is_active ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-green-500 hover:bg-green-600'} text-white transition-all duration-200">
            ${fr.is_active ? 'Deactivate' : 'Activate'}
          </button>
          <button onclick="removeFeaturedRestaurant(${fr.id})" 
                  class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm transition-all duration-200">
            Remove
          </button>
        </div>
      </div>
    `).join("");
  } catch (err) {
    console.error("Error loading featured restaurants:", err);
    showToast("Failed to load featured restaurants", false);
  }
}

async function addFeaturedRestaurant() {
  const restaurantId = document.getElementById("featuredRestaurantId").value;
  const position = document.getElementById("featuredPosition").value || 1;
  
  if (!restaurantId) {
    showToast("Please enter a restaurant ID", false);
    return;
  }
  
  try {
    const res = await fetch(`${BASE}/api/admin/featured-restaurants`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ restaurant_id: parseInt(restaurantId), position: parseInt(position) })
    });
    
    const result = await res.json();
    if (res.ok) {
      showToast("‚úÖ Restaurant added to featured list!");
      document.getElementById("featuredRestaurantId").value = "";
      document.getElementById("featuredPosition").value = "";
      loadFeaturedRestaurants();
    } else {
      showToast("‚ùå " + (result.error || "Failed to add restaurant"), false);
    }
  } catch (err) {
    showToast("‚ùå Network error", false);
    console.error("Add featured restaurant error:", err);
  }
}

async function removeFeaturedRestaurant(id) {
  if (!confirm("Are you sure you want to remove this restaurant from featured list?")) return;
  
  try {
    const res = await fetch(`${BASE}/api/admin/featured-restaurants/${id}`, {
      method: "DELETE"
    });
    
    const result = await res.json();
    if (res.ok) {
      showToast("‚úÖ Restaurant removed from featured list");
      loadFeaturedRestaurants();
    } else {
      showToast("‚ùå " + (result.error || "Failed to remove restaurant"), false);
    }
  } catch (err) {
    showToast("‚ùå Network error", false);
    console.error("Remove featured restaurant error:", err);
  }
}

async function toggleFeaturedRestaurant(id, currentStatus) {
  try {
    const res = await fetch(`${BASE}/api/admin/featured-restaurants/${id}/toggle`, {
      method: "PUT"
    });
    
    const result = await res.json();
    if (res.ok) {
      showToast(`‚úÖ Restaurant ${result.is_active ? 'activated' : 'deactivated'}`);
      loadFeaturedRestaurants();
    } else {
      showToast("‚ùå " + (result.error || "Failed to toggle restaurant"), false);
    }
  } catch (err) {
    showToast("‚ùå Network error", false);
    console.error("Toggle featured restaurant error:", err);
  }
}

// Fetch and display all orders for the admin
async function fetchAllOrders() {
  try {
    const response = await fetch(`/api/orders`);
    if (!response.ok) {
      throw new Error('Failed to fetch orders');
    }

    const orders = await response.json();
    console.log('All Orders:', orders);

    // Display orders dynamically (example)
    const ordersContainer = document.getElementById('ordersContainer');
    ordersContainer.innerHTML = orders.map(order => `
      <div class="order">
        <p><b>Order ID:</b> ${order.id}</p>
        <p><b>Status:</b> ${order.status}</p>
        <p><b>Total:</b> ‚Çπ${order.total}</p>
      </div>
    `).join('');
  } catch (error) {
    console.error('Error fetching orders:', error);
  }
}

document.addEventListener('DOMContentLoaded', fetchAllOrders);

// ===== Logout =====
function logout() {
  localStorage.removeItem("user");
  localStorage.removeItem("token");
  window.location.href = "login.html";
}

// ===== Init =====
loadStats();
loadPendingRestaurants();
loadAllMenu();
loadDeliveryBoys();
loadActiveOrders();
loadFeaturedRestaurants();
loadTopRestaurants();

// ===== Charts Demo =====
new Chart(document.getElementById("ordersChart"), {
  type: "bar",
  data: {
    labels: ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],
    datasets: [{
      label: "Orders",
      data: [40,55,30,60,70,90,50],
      backgroundColor: "rgba(34,197,94,0.6)"
    }]
  }
});
new Chart(document.getElementById("revenueChart"), {
  type: "line",
  data: {
    labels: ["Jan","Feb","Mar","Apr","May","Jun"],
    datasets: [{
      label: "Revenue",
      data: [20000,25000,18000,30000,40000,35000],
      borderColor: "rgba(34,197,94,1)",
      backgroundColor: "rgba(34,197,94,0.2)",
      fill: true
    }]
  }
});
</script>
</body>
</html>
