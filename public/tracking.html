<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tindo ‚Äì Order Tracking</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" href="assets/png.jpg" />
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <style>
    body {
      background: linear-gradient(135deg,#f6fff7 0%,#e5fbe7 100%);
      font-family: "Poppins", sans-serif;
    }
    @keyframes fadeInUp { from {opacity:0;transform:translateY(10px);} to {opacity:1;transform:translateY(0);} }
    .fade-up{animation:fadeInUp .6s ease-in-out;}
    /* small card like look */
    .card{background:white;border-radius:12px;padding:12px;border:1px solid #eef7f0}
    /* map styling */
    #map{width:100%;height:360px;border-radius:12px;}
    /* simple emoji icons */
    .rider-icon{font-size:22px}
    .rest-icon{font-size:20px}
    .cust-icon{font-size:20px}
  </style>
</head>

<body class="min-h-screen flex flex-col items-center p-4">

  <!-- Header -->
  <header class="w-full max-w-3xl flex items-center justify-between mb-3">
    <div class="flex items-center space-x-2">
      <img src="assets/png.jpg" class="w-10 h-10 rounded-full" />
      <h1 class="text-xl font-bold text-gray-800">Tindo Tracking</h1>
    </div>
    <div class="text-right text-sm text-gray-600">
      <p>Order ID: <strong id="orderIdLabel">TND9876</strong></p>
      <p>Status: <span id="statusLabel" class="text-green-600 font-semibold">Waiting</span></p>
    </div>
  </header>

  <!-- Map -->
  <section id="map" class="w-full max-w-3xl h-72 bg-green-50 border-2 border-green-200 rounded-2xl shadow-inner flex items-center justify-center text-gray-400 mb-4">
    <p id="mapPlaceholder">üó∫Ô∏è Loading live map‚Ä¶</p>
  </section>

  <!-- ETA / Timer -->
  <div class="max-w-3xl w-full flex justify-between text-gray-700 mb-2">
    <p>ETA: <span id="eta">--</span></p>
    <p>Distance: <span id="distance">--</span></p>
    <p>Elapsed: <span id="elapsed">--</span></p>
  </div>

  <!-- Progress Steps (omitted for brevity) -->
  <div class="max-w-3xl w-full bg-white rounded-2xl p-5 shadow-lg fade-up mb-5">
    <h2 class="text-lg font-semibold text-gray-800 mb-3">Delivery Progress</h2>
    <div class="flex justify-between relative">
      <div class="text-center relative progress-step">
        <div class="w-6 h-6 mx-auto rounded-full bg-green-600 text-white flex items-center justify-center text-xs">1</div>
        <p class="text-xs mt-1 text-green-700">Placed</p>
      </div>
      <div class="text-center relative progress-step">
        <div class="w-6 h-6 mx-auto rounded-full bg-green-600 text-white flex items-center justify-center text-xs">2</div>
        <p class="text-xs mt-1 text-green-700">Preparing</p>
      </div>
      <div class="text-center relative progress-step">
        <div class="w-6 h-6 mx-auto rounded-full bg-green-600 text-white flex items-center justify-center text-xs">3</div>
        <p class="text-xs mt-1 text-green-700">Picked Up</p>
      </div>
      <div class="text-center relative">
        <div class="w-6 h-6 mx-auto rounded-full bg-gray-300 text-white flex items-center justify-center text-xs">4</div>
        <p class="text-xs mt-1 text-gray-500">Delivered</p>
      </div>
    </div>
  </div>

  <!-- Delivery Partner Card -->
  <div class="max-w-3xl w-full bg-white rounded-2xl p-5 shadow-lg fade-up mb-5 flex items-center justify-between">
    <div class="flex items-center space-x-4">
      <img src="assets/ping.jpg" alt="Rider" class="w-14 h-14 rounded-full border-2 border-green-200">
      <div class="text-left">
        <p id="riderName" class="font-semibold text-gray-800">Rider</p>
        <p id="riderInfo" class="text-sm text-gray-500">‚Äî</p>
        <p id="riderStatus" class="text-sm text-green-600">‚Äî</p>
      </div>
    </div>
    <div class="space-x-2">
      <a id="callBtn" href="#" class="bg-green-600 text-white px-4 py-2 rounded-xl text-sm font-semibold hover:bg-green-700">Call</a>
      <a href="#" class="border border-green-600 text-green-600 px-4 py-2 rounded-xl text-sm font-semibold hover:bg-green-50">Chat</a>
    </div>
  </div>

  <footer class="text-center text-gray-500 text-sm mb-4">
    üîî Live tracking updates powered by Tindo Smart Track v2
  </footer>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <script>
    // small TODO: SERVER base
    const SERVER = window.SERVER_BASE || 'http://localhost:5000';

    function qs(name){ return new URLSearchParams(location.search).get(name); }
    const orderId = qs('orderId') || localStorage.getItem('last_order_id') || '1';
    document.getElementById('orderIdLabel').textContent = orderId;

    // map variables
    let map, riderMarker, restMarker, custMarker, routeLine;
    // timing
    let tripStartTs = Date.now();
    const avgSpeedKmh = 25; // assumed average rider speed in city traffic

    // Haversine distance in km
    function distanceKm(a, b){
      const toRad = (x)=>x*Math.PI/180;
      const R=6371; // km
      const dLat = toRad(b.lat - a.lat);
      const dLng = toRad(b.lng - a.lng);
      const sa = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.sin(dLng/2)*Math.sin(dLng/2);
      const c = 2*Math.atan2(Math.sqrt(sa), Math.sqrt(1-sa));
      return R*c;
    }

    function setElapsed(){
      const mins = Math.floor((Date.now() - tripStartTs)/60000);
      document.getElementById('elapsed').textContent = mins + ' min';
    }

    function setEtaAndDistance(riderLatLng){
      const custLatLng = custMarker.getLatLng();
      const dKm = distanceKm({lat:riderLatLng.lat, lng:riderLatLng.lng}, {lat:custLatLng.lat, lng:custLatLng.lng});
      const etaMin = Math.max(1, Math.round((dKm/avgSpeedKmh)*60));
      document.getElementById('distance').textContent = dKm.toFixed(1) + ' km';
      document.getElementById('eta').textContent = etaMin + ' min';
    }

    // default demo coordinates (Hyderabad area)
    const demoRestaurant = { lat: 17.387139, lng: 78.491684 };
    const demoCustomer   = { lat: 17.385044, lng: 78.486671 };

    function initMap(center){
      const el = document.getElementById('map');
      // remove placeholder text
      const ph = document.getElementById('mapPlaceholder'); if(ph) ph.remove();
      map = L.map('map', { zoomControl: true }).setView([center.lat, center.lng], 14);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap contributors' }).addTo(map);

      const riderIcon = L.divIcon({ className: 'rider-icon', html: 'üö¥', iconSize:[28,28] });
      const restIcon  = L.divIcon({ className: 'rest-icon', html: 'üç≤', iconSize:[26,26] });
      const custIcon  = L.divIcon({ className: 'cust-icon', html: 'üè†', iconSize:[26,26] });

      riderMarker = L.marker([center.lat, center.lng], { icon: riderIcon }).addTo(map).bindPopup('Delivery Partner');
      // temporary rest and customer, will be positioned when order info available
      restMarker = L.marker([center.lat+0.002, center.lng+0.002], { icon: restIcon }).addTo(map).bindPopup('Restaurant');
      custMarker = L.marker([center.lat-0.002, center.lng-0.002], { icon: custIcon }).addTo(map).bindPopup('You');

      // fit bounds when we have three markers
      fitAllMarkers();
    }

    function fitAllMarkers(){
      if(!map || !riderMarker || !restMarker || !custMarker) return;
      const group = L.featureGroup([riderMarker, restMarker, custMarker]);
      map.fitBounds(group.getBounds().pad(0.4));
    }

    async function fetchOrderInfo(){
      try{
        const res = await fetch(`${SERVER}/api/orders/details/${orderId}`);
        if(res.ok){
          const json = await res.json();
          // Set customer marker from order delivery lat/lng if present
          if (json.delivery && json.delivery.lat && json.delivery.lng) {
            custMarker.setLatLng([json.delivery.lat, json.delivery.lng]).bindPopup('You');
          } else {
            custMarker.setLatLng([demoCustomer.lat, demoCustomer.lng]).bindPopup('You');
          }
          // Agent info
          if (json.agent) {
            document.getElementById('riderName').textContent = json.agent.name || 'Delivery Partner';
            document.getElementById('riderInfo').textContent = json.agent.phone ? `üìû ${json.agent.phone}` : '';
            // Wire call/chat
            const callBtn = document.getElementById('callBtn');
            if (json.agent.phone) callBtn.href = `tel:${json.agent.phone}`;
          }
          document.getElementById('statusLabel').textContent = json.status || 'On the way';
        } else {
          // fallback to demo coords
          restMarker.setLatLng([demoRestaurant.lat, demoRestaurant.lng]);
          custMarker.setLatLng([demoCustomer.lat, demoCustomer.lng]);
        }
      } catch(e){
        // server not reachable ‚Äî use demo positions
        restMarker.setLatLng([demoRestaurant.lat, demoRestaurant.lng]);
        custMarker.setLatLng([demoCustomer.lat, demoCustomer.lng]);
        console.warn('Order info fetch failed', e);
      } finally{
        fitAllMarkers();
      }
    }

    // Poll rider location from server endpoint; expects { lat, lng }
    let polling = true;
    async function fetchLocation(){
      if(!polling) return;
      try{
        const res = await fetch(`${SERVER}/api/delivery/location/${orderId}`);
        if(!res.ok) throw new Error('no location');
        const data = await res.json();
        if(data && data.lat && data.lng){
          riderMarker.setLatLng([data.lat, data.lng]);
          // optionally draw a route line
          if(routeLine) routeLine.remove();
          routeLine = L.polyline([[data.lat, data.lng], restMarker.getLatLng(), custMarker.getLatLng()], { color:'#10b981', dashArray:'6,8' }).addTo(map);
          map.panTo([data.lat, data.lng]);
          document.getElementById('statusLabel').textContent = `Driver at ${data.lat.toFixed(4)}, ${data.lng.toFixed(4)}`;
          // update ETA/distance/elapsed
          setEtaAndDistance({ lat: data.lat, lng: data.lng });
          setElapsed();
        }
      } catch(e){
        // if server unreachable, start a simulator to demonstrate movement
        console.warn('Location fetch failed, starting simulator', e);
        startSimulator();
      }
    }

    // Simple simulator: move rider along straight line from restaurant to customer
    let simInterval = null;
    function startSimulator(){
      if(simInterval) return; // already running
      const from = restMarker.getLatLng();
      const to = custMarker.getLatLng();
      const steps = 60;
      let i = 0;
      simInterval = setInterval(()=>{
        i++;
        const t = i/steps;
        const lat = from.lat + (to.lat - from.lat)*t;
        const lng = from.lng + (to.lng - from.lng)*t;
        riderMarker.setLatLng([lat, lng]);
        document.getElementById('statusLabel').textContent = `Driver at ${lat.toFixed(4)}, ${lng.toFixed(4)} (sim)`;
        if(routeLine) routeLine.remove();
        routeLine = L.polyline([[lat, lng], restMarker.getLatLng(), custMarker.getLatLng()], { color:'#10b981', dashArray:'6,8' }).addTo(map);
        map.panTo([lat, lng]);
        setEtaAndDistance({ lat, lng });
        setElapsed();
        if(i>=steps){ clearInterval(simInterval); simInterval = null; document.getElementById('statusLabel').textContent='Driver near you (sim)'; }
      }, 1000);
    }

    // Initialize map when DOM ready
    document.addEventListener('DOMContentLoaded', ()=>{
      // initial center between demo points
      const center = { lat: (demoRestaurant.lat+demoCustomer.lat)/2, lng: (demoRestaurant.lng+demoCustomer.lng)/2 };
      initMap(center);
      fetchOrderInfo();
      // try to fetch live location; poll every 3s
      fetchLocation();
      setInterval(fetchLocation, 3000);
      // initial elapsed ticker
      setInterval(setElapsed, 60000);
    });
  </script>

</body>
</html>

